<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments :: head (titulo='Lista de Tareas')">
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <style>
        .tarea-completada {
            text-decoration: line-through;
            opacity: 0.5;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row mt-3">
        <div class="col">
            <h2 th:text="'Listado de tareas de ' + ${usuario.nombre}"></h2>
        </div>
    </div>

    <div class="row mt-3">
        <div class="col">
            <div class="row mt-3 mb-3">
                <div class="col-md-4">
                    <input type="text" id="filtroTitulo" class="form-control" placeholder="🔍 Buscar por título...">
                </div>
                <div class="col-md-4">
                    <select id="filtroPrioridad" class="form-control">
                        <option value="">🎯 Todas las prioridades</option>
                        <option value="BAJA">🟢 Baja</option>
                        <option value="MEDIA">🟡 Media</option>
                        <option value="ALTA">🔴 Alta</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="date" id="filtroFecha" class="form-control" placeholder="📅 Filtrar por fecha límite">
                </div>
            </div>

            <table class="table table-striped">
                <thead>
                <tr>
                    <th>Id</th>
                    <th>Tarea</th>
                    <th>Prioridad</th>
                    <th>Fecha Límite</th>
                    <th>Acción</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="tarea: ${tareas}"
                    th:attr="data-titulo=${tarea.titulo}, data-prioridad=${tarea.prioridad}, data-fecha=${tarea.fechaLimite}">
                    <td th:text="${tarea.id}"></td>
                    <td>
                        <input type="checkbox"
                               class="checkbox-completada mr-2"
                               th:attr="data-id=${tarea.id}"
                               th:checked="${tarea.completada}" />

                        <span th:text="${tarea.titulo}"
                              th:classappend="${tarea.completada} ? 'tarea-completada' : ''"></span>
                    </td>
                    <td>
                        <span th:text="${tarea.prioridad}"
                              class="badge"
                              th:classappend="${#strings.equals(tarea.prioridad, 'ALTA')} ? 'badge-danger' :
                                              (${#strings.equals(tarea.prioridad, 'MEDIA')} ? 'badge-warning text-dark' :
                                              (${#strings.equals(tarea.prioridad, 'BAJA')} ? 'badge-success' : 'badge-secondary'))">
                        </span>
                    </td>
                    <td>
                        <span th:text="${tarea.fechaLimite}"
                              th:classappend="${tarea.fechaLimiteProxima} ? 'text-danger font-weight-bold' : ''">
                        </span>
                        <span th:if="${tarea.fechaLimiteProxima}" class="badge badge-pill badge-warning ml-2" title="¡Esta tarea vence pronto!">
                            ⚠️ Urgente
                        </span>
                    </td>
                    <td>
                        <a class="btn btn-primary btn-xs" th:href="@{/tareas/{id}/editar(id=${tarea.id})}">editar</a>
                        <button class="btn btn-danger btn-xs" style="cursor: pointer;"
                                data-toggle="modal"
                                data-target="#confirmarEliminacionModal"
                                th:attr="data-id=${tarea.id}">borrar</button>
                    </td>
                </tr>
                </tbody>
            </table>

            <p>
                <a class="btn btn-primary" th:href="@{/usuarios/{id}/tareas/nueva(id=${usuario.id})}">Nueva tarea</a>
                <a class="btn btn-link" href="/logout">Salir</a>
            </p>
        </div>
    </div>

    <div class="row mt-2">
        <div class="col">
            <div class="alert alert-success alert-dismissible fade show" role="alert" th:if="${!#strings.isEmpty(mensaje)}">
                <span th:text="${mensaje}"></span>
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmación de Eliminación -->
<div class="modal fade" id="confirmarEliminacionModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalLabel">Confirmar eliminación</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        ¿Estás seguro/a de que deseas eliminar esta tarea?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
        <button id="btnConfirmarEliminar" type="button" class="btn btn-danger">Eliminar</button>
      </div>
    </div>
  </div>
</div>

<!-- Fragmento JavaScript -->
<div th:replace="fragments::javascript"></div>

<!-- Scripts -->
<script>
    let idTareaAEliminar = null;

    $('#confirmarEliminacionModal').on('show.bs.modal', function (event) {
        const button = $(event.relatedTarget);
        idTareaAEliminar = button.data('id');
    });

    document.getElementById('btnConfirmarEliminar').addEventListener('click', function () {
        if (!idTareaAEliminar) return;
        fetch(`/tareas/${idTareaAEliminar}`, {
            method: 'DELETE'
        }).then(() => location.reload());
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".checkbox-completada").forEach(function (checkbox) {
            checkbox.addEventListener("change", function () {
                const tareaId = this.getAttribute("data-id");
                const completada = this.checked;

                fetch(`/api/tareas/${tareaId}/completada`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ completada: completada })
                }).then(response => {
                    if (response.ok) {
                        const row = this.closest("tr");
                        const tituloSpan = row.querySelector("span");
                        if (completada) {
                            tituloSpan.classList.add("tarea-completada");
                        } else {
                            tituloSpan.classList.remove("tarea-completada");
                        }
                    } else {
                        alert("Error al actualizar el estado de la tarea.");
                        this.checked = !completada;
                    }
                });
            });
        });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const filtroTitulo = document.getElementById("filtroTitulo");
        const filtroPrioridad = document.getElementById("filtroPrioridad");
        const filtroFecha = document.getElementById("filtroFecha");
        const filas = document.querySelectorAll("tbody tr");

        function aplicarFiltros() {
            const titulo = filtroTitulo.value.toLowerCase();
            const prioridad = filtroPrioridad.value;
            const fecha = filtroFecha.value;

            filas.forEach(fila => {
                const tituloFila = fila.getAttribute("data-titulo").toLowerCase();
                const prioridadFila = fila.getAttribute("data-prioridad");
                const fechaFila = fila.getAttribute("data-fecha");

                const coincideTitulo = titulo === "" || tituloFila.includes(titulo);
                const coincidePrioridad = prioridad === "" || prioridadFila === prioridad;
                const coincideFecha = fecha === "" || fechaFila === fecha;

                fila.style.display = (coincideTitulo && coincidePrioridad && coincideFecha) ? "" : "none";
            });
        }

        filtroTitulo.addEventListener("input", aplicarFiltros);
        filtroPrioridad.addEventListener("change", aplicarFiltros);
        filtroFecha.addEventListener("change", aplicarFiltros);
    });
</script>
</body>
</html>
