<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="fragments :: head (titulo='Lista de Tareas')">
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
</head>

<body>
<div class="container-fluid">

    <div class="row mt-3">
        <div class="col">
            <h2 th:text="'Listado de tareas de ' + ${usuario.nombre}"></h2>
        </div>
    </div>

    <div class="row mt-3 mb-3">
        <div class="col-md-4">
            <input type="text" id="filtroTitulo" class="form-control" placeholder="🔍 Buscar por título...">
        </div>
        <div class="col-md-4">
            <select id="filtroPrioridad" class="form-control">
                <option value="">🎯 Todas las prioridades</option>
                <option value="BAJA">🟢 Baja</option>
                <option value="MEDIA">🟡 Media</option>
                <option value="ALTA">🔴 Alta</option>
            </select>
        </div>
        <div class="col-md-4">
            <input type="date" id="filtroFecha" class="form-control" placeholder="📅 Filtrar por fecha límite">
        </div>
    </div>

    <div class="row" th:if="${tareas}">
        <div class="col-md-4 mb-4"
             th:each="tarea : ${tareas}"
             th:attr="data-titulo=${tarea.titulo}, data-prioridad=${tarea.prioridad}, data-fecha=${tarea.fechaLimite}">
            <div class="card shadow-sm h-100">
                <div class="card-body d-flex flex-column justify-content-between">
                    <div>
                        <div th:attr="data-id=${tarea.id}" class="editable-titulo d-flex align-items-center justify-content-between w-100">
                            <span class="titulo-texto flex-grow-1 mb-0" th:text="${tarea.titulo}">Título</span>
                            <input class="form-control form-control-sm titulo-input d-none flex-grow-1"
                                   type="text"
                                   th:value="${tarea.titulo}">
                            <button type="button" class="btn btn-outline-secondary btn-sm ml-2" title="Editar título">✏️</button>
                        </div>
                            <input class="form-control form-control-sm titulo-input d-none mt-2"
                                   type="text"
                                   th:value="${tarea.titulo}"
                                   style="max-width: 100%;">
                        </div>
                        <p class="card-text mb-1 mt-2">
                            <strong>Prioridad:</strong>
                            <span th:text="${tarea.prioridad}"
                                  class="badge"
                                  th:classappend="${#strings.equals(tarea.prioridad, 'ALTA')} ? 'badge-danger' :
                                                  (${#strings.equals(tarea.prioridad, 'MEDIA')} ? 'badge-warning text-dark' :
                                                  (${#strings.equals(tarea.prioridad, 'BAJA')} ? 'badge-success' : 'badge-secondary'))">
                            </span>
                        </p>
                        <p class="card-text mb-0">
                            <strong>Fecha límite:</strong>
                            <span th:text="${tarea.fechaLimite}"
                                  th:classappend="${tarea.fechaLimiteProxima} ? 'text-danger font-weight-bold' : ''">
                            </span>
                            <span th:if="${tarea.fechaLimiteProxima}" class="badge badge-pill badge-warning ml-2">
                                ⚠️ Urgente
                            </span>
                        </p>
                    </div>
                    <div class="mt-3 text-right">
                        <button class="btn btn-danger btn-sm"
                                data-toggle="modal"
                                data-target="#confirmarEliminacionModal"
                                th:attr="data-id=${tarea.id}">Borrar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <p>
        <a class="btn btn-primary" th:href="@{/usuarios/{id}/tareas/nueva(id=${usuario.id})}">Nueva tarea</a>
        <a class="btn btn-link" href="/logout">Salir</a>
    </p>

    <div class="row mt-2">
        <div class="col">
            <div class="alert alert-success alert-dismissible fade show" role="alert" th:if="${!#strings.isEmpty(mensaje)}">
                <span th:text="${mensaje}"></span>
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmación de Eliminación -->
<div class="modal fade" id="confirmarEliminacionModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalLabel">Confirmar eliminación</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        ¿Estás seguro/a de que deseas eliminar esta tarea?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
        <button id="btnConfirmarEliminar" type="button" class="btn btn-danger">Eliminar</button>
      </div>
    </div>
  </div>
</div>

<!-- Fragmento para incluir scripts comunes -->
<div th:replace="fragments::javascript"></div>

<script>
    let idTareaAEliminar = null;

    $('#confirmarEliminacionModal').on('show.bs.modal', function (event) {
        const button = $(event.relatedTarget);
        idTareaAEliminar = button.data('id');
    });

    document.getElementById('btnConfirmarEliminar').addEventListener('click', function () {
        if (!idTareaAEliminar) return;
        fetch(`/tareas/${idTareaAEliminar}`, {
            method: 'DELETE'
        }).then(() => location.reload());
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".editable-titulo").forEach(function (wrapper) {
            const spanTexto = wrapper.querySelector(".titulo-texto");
            const input = wrapper.querySelector(".titulo-input");
            const tareaId = wrapper.getAttribute("data-id");

            wrapper.addEventListener("click", function () {
                spanTexto.classList.add("d-none");
                input.classList.remove("d-none");
                input.focus();
            });

            input.addEventListener("keydown", function (e) {
                if (e.key === "Enter") {
                    const nuevoTitulo = input.value.trim();
                    if (nuevoTitulo === "") return;

                    fetch(`/api/tareas/${tareaId}/titulo`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ titulo: nuevoTitulo })
                    }).then(response => {
                        if (response.ok) {
                            spanTexto.textContent = nuevoTitulo;
                            input.classList.add("d-none");
                            spanTexto.classList.remove("d-none");
                        } else {
                            alert("Error al guardar el nuevo título");
                        }
                    });
                }
            });
        });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const filtroTitulo = document.getElementById("filtroTitulo");
        const filtroPrioridad = document.getElementById("filtroPrioridad");
        const filtroFecha = document.getElementById("filtroFecha");
        const tarjetas = document.querySelectorAll(".col-md-4[data-titulo]");

        function aplicarFiltros() {
            const titulo = filtroTitulo.value.toLowerCase();
            const prioridad = filtroPrioridad.value;
            const fecha = filtroFecha.value;

            tarjetas.forEach(card => {
                const tituloCard = card.getAttribute("data-titulo").toLowerCase();
                const prioridadCard = card.getAttribute("data-prioridad");
                const fechaCard = card.getAttribute("data-fecha");

                const coincideTitulo = titulo === "" || tituloCard.includes(titulo);
                const coincidePrioridad = prioridad === "" || prioridadCard === prioridad;
                const coincideFecha = fecha === "" || fechaCard === fecha;

                card.style.display = (coincideTitulo && coincidePrioridad && coincideFecha) ? "" : "none";
            });
        }

        filtroTitulo.addEventListener("input", aplicarFiltros);
        filtroPrioridad.addEventListener("change", aplicarFiltros);
        filtroFecha.addEventListener("change", aplicarFiltros);
    });
</script>
</body>
</html>
