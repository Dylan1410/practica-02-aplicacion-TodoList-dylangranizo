<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="fragments :: head (titulo='Lista de Tareas')">
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
</head>

<body>
<div class="container-fluid">

    <div class="row mt-3">
        <div class="col">
            <h2 th:text="'Listado de tareas de ' + ${usuario.nombre}"></h2>
        </div>
    </div>

    <div class="row mt-3">
        <div class="col">
            <div class="row mt-3 mb-3">
                <div class="col-md-4">
                    <input type="text" id="filtroTitulo" class="form-control" placeholder="üîç Buscar por t√≠tulo...">
                </div>
                <div class="col-md-4">
                    <select id="filtroPrioridad" class="form-control">
                        <option value="">üéØ Todas las prioridades</option>
                        <option value="BAJA">üü¢ Baja</option>
                        <option value="MEDIA">üü° Media</option>
                        <option value="ALTA">üî¥ Alta</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="date" id="filtroFecha" class="form-control" placeholder="üìÖ Filtrar por fecha l√≠mite">
                </div>
            </div>

            <table class="table table-striped">
                <thead>
                <tr>
                    <th>Id</th>
                    <th>Tarea</th>
                    <th>Prioridad</th>
                    <th>Fecha L√≠mite</th>
                    <th>Acci√≥n</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="tarea: ${tareas}"
                    th:attr="data-titulo=${tarea.titulo}, data-prioridad=${tarea.prioridad}, data-fecha=${tarea.fechaLimite}">
                    <td th:text="${tarea.id}"></td>
                    <td>
                        <span th:attr="data-id=${tarea.id}" class="editable-titulo d-inline-flex align-items-center" style="gap: 5px; cursor: pointer;">
                            <span class="emoji-icon">‚úèÔ∏è</span>
                            <span class="titulo-texto" th:text="${tarea.titulo}"></span>
                            <input class="form-control form-control-sm titulo-input d-none" type="text" th:value="${tarea.titulo}" style="width: auto; max-width: 300px;">
                        </span>
                    </td>
                    <td>
                        <span th:text="${tarea.prioridad}"
                              class="badge"
                              th:classappend="${#strings.equals(tarea.prioridad, 'ALTA')} ? 'badge-danger' :
                                              (${#strings.equals(tarea.prioridad, 'MEDIA')} ? 'badge-warning text-dark' :
                                              (${#strings.equals(tarea.prioridad, 'BAJA')} ? 'badge-success' : 'badge-secondary'))">
                        </span>
                    </td>
                    <td>
                        <span th:text="${tarea.fechaLimite}"
                              th:classappend="${tarea.fechaLimiteProxima} ? 'text-danger font-weight-bold' : ''">
                        </span>

                        <span th:if="${tarea.fechaLimiteProxima}" class="badge badge-pill badge-warning ml-2" title="¬°Esta tarea vence pronto!">
                            ‚ö†Ô∏è Urgente
                        </span>
                    </td>
                    <td>
                        <a class="btn btn-primary btn-xs" th:href="@{/tareas/{id}/editar(id=${tarea.id})}">editar</a>
                        <button class="btn btn-danger btn-xs" style="cursor: pointer;"
                                th:onclick="'del(\'/tareas/' + ${tarea.id} + '\')'">borrar</button>
                    </td>
                </tr>
                </tbody>
            </table>

            <p>
                <a class="btn btn-primary" th:href="@{/usuarios/{id}/tareas/nueva(id=${usuario.id})}">Nueva tarea</a>
                <a class="btn btn-link" href="/logout">Salir</a>
            </p>
        </div>
    </div>

    <div class="row mt-2">
        <div class="col">
            <div class="alert alert-success alert-dismissible fade show" role="alert" th:if="${!#strings.isEmpty(mensaje)}">
                <span th:text="${mensaje}"></span>
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Fragmento JavaScript -->
<div th:replace="fragments::javascript"/>

<!-- Scripts funcionales -->
<script type="text/javascript">
    function del(urlBorrar) {
        if (confirm('¬øEst√°s seguro/a de que quieres borrar la tarea?')) {
            fetch(urlBorrar, {
                method: 'DELETE'
            }).then((res) => location.reload());
        }
    }
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".editable-titulo").forEach(function (wrapper) {
            const spanTexto = wrapper.querySelector(".titulo-texto");
            const input = wrapper.querySelector(".titulo-input");
            const tareaId = wrapper.getAttribute("data-id");

            wrapper.addEventListener("click", function () {
                spanTexto.classList.add("d-none");
                input.classList.remove("d-none");
                input.focus();
            });

            input.addEventListener("keydown", function (e) {
                if (e.key === "Enter") {
                    const nuevoTitulo = input.value.trim();
                    if (nuevoTitulo === "") return;

                    fetch(`/api/tareas/${tareaId}/titulo`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ titulo: nuevoTitulo })
                    }).then(response => {
                        if (response.ok) {
                            spanTexto.textContent = nuevoTitulo;
                            input.classList.add("d-none");
                            spanTexto.classList.remove("d-none");
                        } else {
                            alert("Error al guardar el nuevo t√≠tulo");
                        }
                    });
                }
            });
        });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const filtroTitulo = document.getElementById("filtroTitulo");
        const filtroPrioridad = document.getElementById("filtroPrioridad");
        const filtroFecha = document.getElementById("filtroFecha");
        const filas = document.querySelectorAll("tbody tr");

        function aplicarFiltros() {
            const titulo = filtroTitulo.value.toLowerCase();
            const prioridad = filtroPrioridad.value;
            const fecha = filtroFecha.value;

            filas.forEach(fila => {
                const tituloFila = fila.getAttribute("data-titulo").toLowerCase();
                const prioridadFila = fila.getAttribute("data-prioridad");
                const fechaFila = fila.getAttribute("data-fecha");

                const coincideTitulo = titulo === "" || tituloFila.includes(titulo);
                const coincidePrioridad = prioridad === "" || prioridadFila === prioridad;
                const coincideFecha = fecha === "" || fechaFila === fecha;

                fila.style.display = (coincideTitulo && coincidePrioridad && coincideFecha) ? "" : "none";
            });
        }

        filtroTitulo.addEventListener("input", aplicarFiltros);
        filtroPrioridad.addEventListener("change", aplicarFiltros);
        filtroFecha.addEventListener("change", aplicarFiltros);
    });
</script>
</body>
</html>
