<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="fragments :: head (titulo='Lista de Tareas')">
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
</head>

<body>
    <div class="container-fluid p-0">
        <div class="row no-gutters">
            <!-- ğŸŒ Sidebar visualmente mejorado -->
            <div class="col-md-8 d-flex flex-column align-items-center py-4"
                 style="
                     position: fixed;
                     top: 0;
                     left: 0;
                     bottom: 0;
                     width: 240px;
                     background: linear-gradient(to bottom, #66d2e2, #4bb1c7);
                     color: white;
                     z-index: 1030;
                     box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
                     font-family: 'Segoe UI', sans-serif;
                 ">
                

                <!-- Contenido del navbar desde fragment -->
                <div th:replace="fragments :: navbar(${usuario})" class="w-100"></div>
            </div>
    

    
            <!-- ğŸ“‹ Contenido principal a la derecha -->
            <div class="col-md-10 p-4" style="margin-left: 14.666667%; background-color: #d4e2ec;">
                <div class="mt-3">
                    <h2 th:text="'Listado de tareas de ' + ${usuario.nombre}"></h2>
                </div>
    <!-- ğŸ” Filtros -->
    <div class="row mt-3 mb-3">
        <div class="col-md-4">
            <input type="text" id="filtroTitulo" class="form-control" placeholder="ğŸ” Buscar por tÃ­tulo...">
        </div>
        <div class="col-md-4">
            <select id="filtroPrioridad" class="form-control">
                <option value="">ğŸ¯ Todas las prioridades</option>
                <option value="BAJA">ğŸŸ¢ Baja</option>
                <option value="MEDIA">ğŸŸ¡ Media</option>
                <option value="ALTA">ğŸ”´ Alta</option>
            </select>
        </div>
        <div class="col-md-4">
            <input type="date" id="filtroFecha" class="form-control" placeholder="ğŸ“… Filtrar por fecha lÃ­mite">
        </div>
    </div>
<!-- ğŸ“ Lista de tareas -->
<div class="row">

    <!-- Tareas existentes -->
    <div class="col-md-4 mb-4"
         th:each="tarea : ${tareas}"
         th:attr="data-id=${tarea.id}, data-titulo=${tarea.titulo}, data-prioridad=${tarea.prioridad.name()}, data-fecha=${tarea.fechaLimite}">
        <div class="card shadow-sm h-100">
            <div class="card-body d-flex flex-column justify-content-between">

                <!-- TÃTULO editable -->
                <div th:attr="data-id=${tarea.id}" class="editable-titulo d-flex align-items-center justify-content-between w-100 mb-2">
                    <span class="titulo-texto flex-grow-1" th:text="${tarea.titulo}"></span>
                    <input class="form-control form-control-sm titulo-input d-none flex-grow-1" type="text" th:value="${tarea.titulo}">
                    <button type="button" class="btn btn-sm btn-outline-secondary ml-2">âœï¸</button>
                </div>
<!-- DESCRIPCIÃ“N -->
<div th:if="${tarea.descripcion}" th:utext="${tarea.descripcion}" class="mb-2 small"></div>

           <!-- PRIORIDAD editable -->
<div class="mb-2">
    <label class="font-weight-bold mb-1">Prioridad:</label>
    <select class="form-control form-control-sm editable-prioridad" th:attr="data-id=${tarea.id}">
        <option value="BAJA" th:selected="${tarea.prioridad.name() == 'BAJA'}">ğŸŸ¢ Baja</option>
        <option value="MEDIA" th:selected="${tarea.prioridad.name() == 'MEDIA'}">ğŸŸ¡ Media</option>
        <option value="ALTA" th:selected="${tarea.prioridad.name() == 'ALTA'}">ğŸ”´ Alta</option>
    </select>
</div>


                <!-- FECHA editable -->
                <div class="mb-2">
                    <label class="font-weight-bold mb-1">Fecha lÃ­mite:</label>
                    <input type="date" class="form-control form-control-sm editable-fecha" th:value="${tarea.fechaLimite}" th:attr="data-id=${tarea.id}">
                    <span class="badge badge-pill badge-warning mt-2 urgente-badge"
                          th:if="${tarea.fechaLimiteProxima}" style="display: inline;">âš ï¸ Urgente</span>
                    <span class="badge badge-pill badge-warning mt-2 urgente-badge"
                          th:unless="${tarea.fechaLimiteProxima}" style="display: none;">âš ï¸ Urgente</span>
                </div>

                <!-- BORRAR -->
                <div class="text-right mt-2">
                    <button class="btn btn-danger btn-sm"
                            data-toggle="modal"
                            data-target="#confirmarEliminacionModal"
                            th:attr="data-id=${tarea.id}">Borrar</button>
                </div>

            </div>
        </div>
    </div>

<!-- â• BOTÃ“N DE NUEVA TAREA COMO TARJETA -->
<div class="col-md-4 mb-4">
    <div class="card shadow-sm h-100 text-center"
         style="cursor: pointer; background-color: #f0f8ff;"
         data-toggle="modal" data-target="#modalNuevaTarea">
        <div class="card-body d-flex flex-column justify-content-center align-items-center">
            <div>
                <h2 style="font-size: 64px; margin: 0; color: #443366;">âœï¸</h2>
                <p class="mt-2 mb-0 text-muted">Nueva tarea</p>
            </div>
        </div>
    </div>
</div>


<!-- âœ… Flash mensaje centrado abajo -->
<div th:if="${!#strings.isEmpty(mensaje)}"
     id="alerta-mensaje"
     class="alert alert-success alert-dismissible fade show text-center"
     role="alert"
     style="position: fixed; bottom: 20px; left: 52%; z-index: 1055; min-width: 250px;">
    <span th:text="${mensaje}"></span>
</div>

</div> <!-- Fin de la fila de tareas -->
</div> <!-- Fin del contenido principal -->
</div> <!-- Fin de la fila -->
</div> <!-- Fin del contenedor fluido -->

<!-- Modal de confirmaciÃ³n de eliminaciÃ³n -->
<div class="modal fade" id="confirmarEliminacionModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLabel">Confirmar eliminaciÃ³n</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Â¿EstÃ¡s seguro/a de que deseas eliminar esta tarea?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button id="btnConfirmarEliminar" type="button" class="btn btn-danger">Eliminar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para crear nueva tarea -->
<div class="modal fade" id="modalNuevaTarea" tabindex="-1" role="dialog" aria-labelledby="nuevaTareaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <form th:action="@{/usuarios/{id}/tareas/nueva(id=${usuario.id})}" method="post" th:object="${tareaData}">
            <div class="modal-content">

                <!-- Encabezado -->
                <div class="modal-header">
                    <h5 class="modal-title" id="nuevaTareaLabel">âœï¸ Crear nueva tarea</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <!-- Cuerpo del modal -->
                <div class="modal-body">
                    <div class="form-group">
                        <label for="tituloTarea">TÃ­tulo</label>
                        <input type="text" class="form-control" id="tituloTarea" placeholder="Escribe un tÃ­tulo" th:field="*{titulo}" required>
                    </div>

                    <div class="form-group">
                        <label for="descripcionEditor">DescripciÃ³n</label>
                        <div id="descripcionEditor" style="height: 150px; background-color: white; border: 1px solid #ced4da; border-radius: .25rem;"></div>
                        <input type="hidden" th:field="*{descripcion}" id="descripcion" name="descripcion">
                    </div>

                    <div class="form-group">
                        <label for="prioridadTarea">Prioridad</label>
                        <select class="form-control" id="prioridadTarea" th:field="*{prioridad}">
                            <option value="BAJA">ğŸŸ¢ Baja</option>
                            <option value="MEDIA">ğŸŸ¡ Media</option>
                            <option value="ALTA">ğŸ”´ Alta</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="fechaLimiteTarea">Fecha lÃ­mite</label>
                        <input type="date" class="form-control" id="fechaLimiteTarea" th:field="*{fechaLimite}"
                               min="[[${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}]]">
                    </div>
                </div>

                <!-- Pie del modal -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar tarea</button>
                </div>

            </div>
        </form>
    </div>
</div>


  
<!--------------------------------------FUNCIONALIDADES CON JS----------------------------------------------------------------------------------------->
<!-- Scripts comunes -->
<div th:replace="fragments::javascript"></div>

<!-- âœ… Scripts funcionales adicionales-->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // === TÃTULO editable ===
        document.querySelectorAll(".editable-titulo").forEach(function (wrapper) {
            const span = wrapper.querySelector(".titulo-texto");
            const input = wrapper.querySelector(".titulo-input");
            const btn = wrapper.querySelector("button");
            const id = wrapper.getAttribute("data-id");
    
            btn.addEventListener("click", () => {
                span.classList.add("d-none");
                input.classList.remove("d-none");
                input.focus();
            });
    
            input.addEventListener("keydown", function (e) {
                if (e.key === "Enter") {
                    const nuevo = input.value.trim();
                    if (!nuevo) return;
    
                    fetch(`/api/tareas/${id}/titulo`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ titulo: nuevo })
                    }).then(r => {
                        if (r.ok) {
                            span.textContent = nuevo;
                            input.classList.add("d-none");
                            span.classList.remove("d-none");
                            wrapper.closest(".col-md-4").setAttribute("data-titulo", nuevo);
                        } else {
                            alert("Error al guardar tÃ­tulo");
                        }
                    });
                }
            });
        });
    
        // === PRIORIDAD editable ===
        document.querySelectorAll(".editable-prioridad").forEach(select => {
            select.addEventListener("change", () => {
                const id = select.getAttribute("data-id");
                const valor = select.value;
    
                fetch(`/api/tareas/${id}/prioridad`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ prioridad: valor })
                }).then(r => {
                    if (!r.ok) {
                        alert("Error al actualizar prioridad");
                    } else {
                        select.closest(".col-md-4").setAttribute("data-prioridad", valor);
                    }
                });
            });
        });
    
        // === FECHA editable + alerta urgente ===
        document.querySelectorAll(".editable-fecha").forEach(input => {
            input.addEventListener("change", () => {
                const id = input.getAttribute("data-id");
                const fecha = input.value;
    
                fetch(`/api/tareas/${id}/fechaLimite`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fechaLimite: fecha })
                }).then(r => {
                    if (!r.ok) {
                        alert("Error al actualizar fecha");
                        return;
                    }
    
                    const hoy = new Date();
                    const futura = new Date(fecha);
                    const dias = Math.ceil((futura - hoy) / (1000 * 60 * 60 * 24));
    
                    document.querySelectorAll(`.col-md-4[data-id='${id}'] .urgente-badge`).forEach(b => {
                        b.style.display = dias <= 3 ? 'inline' : 'none';
                    });
    
                    input.closest(".col-md-4").setAttribute("data-fecha", fecha);
                });
            });
        });
    
        // === FILTROS ===
        const filtroTitulo = document.getElementById("filtroTitulo");
        const filtroPrioridad = document.getElementById("filtroPrioridad");
        const filtroFecha = document.getElementById("filtroFecha");
    
        function aplicarFiltros() {
            const titulo = filtroTitulo.value.toLowerCase();
            const prioridad = filtroPrioridad.value;
            const fecha = filtroFecha.value;
            const tarjetas = document.querySelectorAll(".col-md-4[data-titulo]");
    
            tarjetas.forEach(card => {
                const tituloCard = card.getAttribute("data-titulo").toLowerCase();
                const prioridadCard = card.getAttribute("data-prioridad");
                const fechaCard = card.getAttribute("data-fecha");
    
                const coincideTitulo = titulo === "" || tituloCard.includes(titulo);
                const coincidePrioridad = prioridad === "" || prioridadCard === prioridad;
                const coincideFecha = fecha === "" || fechaCard === fecha;
    
                card.style.display = (coincideTitulo && coincidePrioridad && coincideFecha) ? "" : "none";
            });
        }
    
        filtroTitulo?.addEventListener("input", aplicarFiltros);
        filtroPrioridad?.addEventListener("change", aplicarFiltros);
        filtroFecha?.addEventListener("change", aplicarFiltros);
    
        // === ConfirmaciÃ³n de eliminaciÃ³n de tarea ===
        let idTareaAEliminar = null;
        const eliminarModal = document.getElementById('confirmarEliminacionModal');
        const btnConfirmarEliminar = document.getElementById('btnConfirmarEliminar');
    
        if (eliminarModal && btnConfirmarEliminar) {
            $(eliminarModal).on('show.bs.modal', function (event) {
                const button = $(event.relatedTarget);
                idTareaAEliminar = button.data('id');
            });
    
            btnConfirmarEliminar.addEventListener('click', function () {
                if (!idTareaAEliminar) return;
                fetch(`/tareas/${idTareaAEliminar}`, {
                    method: 'DELETE'
                }).then(() => location.reload());
            });
        }
    
        // === Autoocultar mensaje de Ã©xito ===
        setTimeout(function () {
            const alerta = document.getElementById('alerta-mensaje');
            if (alerta) {
                alerta.classList.remove('show');
                alerta.classList.add('fade');
                alerta.style.opacity = '0';
                setTimeout(() => alerta.remove(), 500);
            }
        }, 1500);
    });
    </script>
    <!-- Quill -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<!-- Script para crear tarea -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const quill = new Quill('#descripcionEditor', {
        theme: 'snow',
        placeholder: 'Escribe una descripciÃ³n detallada...',
        modules: {
            toolbar: [
                ['bold', 'italic', 'underline'],
                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                ['link']
            ]
        }
    });

    const form = document.querySelector("#modalNuevaTarea form");
    form.addEventListener("submit", () => {
        document.getElementById('descripcion').value = quill.root.innerHTML;
    });
});
</script>

</body>
</html>
